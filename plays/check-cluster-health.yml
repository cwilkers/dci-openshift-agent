---
- name: "Wait 30 seconds for operators to stabilize"
  pause:
    seconds: 30

- name: "Check cluster info"
  community.kubernetes.k8s_info:
    kind: ClusterOperator
  register: operator_info

- name: "Fail if any ClusterOperator last status is Degraded/True - {{ version }}"
  vars:
    last_timestamp: "resources[*].{name: metadata.name, last: sort_by(status.conditions, &lastTransitionTime)[-1]}"
  set_fact:
    # converting to/from JSON is a workaround for a Jinja2 bug
    operator_status: "{{ operator_info | to_json | from_json | json_query(last_timestamp) }}"
  failed_when: >-
    operator_status |
    selectattr('last.type', 'eq', 'Degraded') |
    selectattr('last.status', 'eq', 'True') |
    list |
    length > 0

- name: "Check that control-plane nodes are ready"
  community.kubernetes.k8s_info:
    kind: Node
    label_selectors:
      - "node-role.kubernetes.io/master"
  register: nodes_info
  vars:
    status_query: "resources[*].status.conditions[?type=='Ready'].status"
    nodes_status: "{{ nodes_info | json_query(status_query) | flatten | unique }}"
  until:
    - nodes_status == ['True']
  retries: 3
  delay: 10

- name: "Check that Worker nodes are ready"
  community.kubernetes.k8s_info:
    kind: Node
    label_selectors:
      - "node-role.kubernetes.io/worker"
  register: nodes_info
  vars:
    status_query: "resources[*].status.conditions[?type=='Ready'].status"
    nodes_status: "{{ nodes_info | json_query(status_query) | flatten | unique }}"
  until:
    - nodes_status == ['True']
  retries: 6
  delay: 10

- name: "Get cluster version information"
  community.kubernetes.k8s_info:
    kind: ClusterVersion
    name: version
  register: cluster_version
  until: "'resources' in cluster_version and cluster_version.resources != []"
  retries: 3
  delay: 10

- name: "Fail if cluster installation/upgrade is not Complete"
  vars:
    upgrade_state: "{{ cluster_version | json_query('resources[0].status.history[0].state') }}"
  fail:
    msg: "Install or upgrade is not Completed"
  when:
    upgrade_state != "Completed"
  retries: 3
  delay: 10

- name: "Check machine-config clusteroperator latest status"
  community.kubernetes.k8s_info:
    api_version: config.openshift.io/v1
    kind: ClusterOperator
    name: machine-config
  register: co
  retries: 120
  delay: 10
  until:
    - co | json_query('resources[*].status.conditions[]')| sort(attribute='lastTransitionTime') | last | json_query('status')

- name: "Get Machine Config Pools status"
  community.kubernetes.k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
  register: reg_mcpool_status
  vars:
    status_query: "resources[*].status.conditions[?type=='Updated'].status"
    update_status: "{{ reg_mcpool_status | json_query(status_query) | flatten | unique }}"
  until:
    - reg_mcpool_status.resources is defined
    - update_status == ['True']
  retries: 180
  delay: 10
...
